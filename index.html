import requests
import json
import csv

# Step 1: Read the address.txt file
def read_addresses(file_path):
    with open(file_path, 'r') as file:
        return [line.strip() for line in file]

# Step 2: Query the API and fetch results
def fetch_wallet_data(wallet_address):
    url = f"https://api.getgrass.io/airdropAllocations?input=%7B%22walletAddress%22:%22{wallet_address}%22%7D"
    response = requests.get(url)
    if response.status_code == 200:
        data = response.json()
        if "result" in data and "data" in data["result"]:
            return data["result"]["data"]
    return {}

# Step 3: Calculate the sum of all values in the 'data' dictionary and determine if it's a Sybil case
def calculate_sum_and_sybil(data):
    total_sum = sum(data.values())
    # Check if any key contains 'sybil', which marks the data as Sybil
    is_sybil = any('sybil' in key.lower() for key in data.keys())
    return total_sum, is_sybil

# Step 4: Write the results to a CSV file with columns Address, Sum, and isSybil
def write_to_csv(results, output_file):
    with open(output_file, 'w', newline='') as csvfile:
        writer = csv.writer(csvfile)
        # Write header
        writer.writerow(["Address", "Sum", "isSybil"])
        # Write each address, its corresponding sum, and Sybil flag
        for address, (total_sum, is_sybil) in results.items():
            writer.writerow([address, total_sum, is_sybil])

# Main function to process everything
def main():
    # File paths
    input_file = 'address.txt'
    output_file = 'result.csv'
    
    # Dictionary to store the sum and sybil status for each wallet address
    wallet_sums_and_sybil = {}

    # Read addresses from file
    addresses = read_addresses(input_file)
    
    # Fetch data for each address and calculate the sum and Sybil status
    for address in addresses:
        wallet_data = fetch_wallet_data(address)
        total_sum, is_sybil = calculate_sum_and_sybil(wallet_data)
        wallet_sums_and_sybil[address] = (total_sum, is_sybil)

    # Write the results to result.csv
    write_to_csv(wallet_sums_and_sybil, output_file)
    print(f"Results saved to {output_file}")

# Run the main function
if __name__ == "__main__":
    main()
